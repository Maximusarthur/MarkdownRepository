## CSRF跨站请求伪造

### 一、CSRF基础知识

#### 1.1 CSRF攻击介绍

CSRF 的全名是 Cross Site Request Forgery，翻译成中文就是跨站请求伪造，它是一种常见的Web 攻击，也被称为“One Click Attack”或者Session Riding，通常缩写为CSRF或者XSRF，是一种对网站的恶意利用。

CSRF攻击通常利用了用户在不知情的情况下访问恶意网站或点击了包含恶意代码的链接。攻击者会在恶意网站中注入代码，向目标网站发送伪造请求。当用户访问恶意网站时，==攻击者就可以利用用户的身份信息向目标网站发送请求，实现攻击目的==。

 CSRF一句话概括：攻击者盗用（伪造）受害者的身份，以受害者的名义向服务器发送恶意请求,而这种恶意请求在服务端看起来是正常请求

**举个例子**

> 我们知道，用户在网页上执行的操作，实际上是向服务端发送 HTTP 请求来实现的。假如一个社交网站中的“添加关注”操作是向如下 URL 发起 GET 请求:http://example.com/follow?id=USERID其中USERID是用户想要关注的另一个用户的UID，正常情况是用户在examplecom 网站上操作发起请求。但是如果用户登录了 example.com 后又访问一个恶意网站 http://evil.site/，其中嵌入了一张指向前面那个 URL的图片，如:
>
> ```
> <img src="http://example.com/follow?id=1234"/>
> ```
>
> 用户在访问这个恶意网站时，浏览器会发起请求加载上述图片，虽然它不是真实的图片，旦是浏览器带着 example.com 的 Cookie 发出了这个请求，那么用户将在不知情的情况下关注UID为 1234 的用户。这个请求并不是用户自己的意图，而是攻击者诱使用户发起的，这种攻击就是CSRF 攻击。

![image-20240724145436114](https://gitee.com/zh0y0/picture/raw/master/zh0y0/image-20240724145436114.png)

#### 1.2 CSRF攻击的本质

在 CSRF 攻击中，攻击者诱使用户的浏览器发起一个恶意请求，本质上是借助用户的凭证以用户的身份去执行特定操作。在用户访问攻击者构造的恶意页面时，如果此时浏览器访问第三方站点(带有 CSRF 漏洞的网站) 带上了第三方 Cookie，那么第三方站点会认为这是一个已登录的用户过来访问，浏览器就能顺利完成相应的操作，所以它叫“跨站请求伪造”。在整个攻击过程中，攻击者并没有拿到受害者的身份凭证，也拿不到操作后的返回结果，他只是诱使受事者发出了一个特定的请求

在大部分情况下，CSRF 攻击过程是，访问当前站点时向第三方站点发起请求并携带了第三方Cookie。

但是在部分场景中，在存在 CSRF 漏洞的网站上就可以向当前站点发起请求，虽然此时并没有“跨站点”，此时也不存在第三方 Cookie，但也叫 CSRF 攻击。

举个例子

> 有些论坛允许用户指定一张图片的 URL作为自己的头像，攻击者就可以将自己的头像设置为执行 CSRF攻击的URL，论坛中所有登录的用户看到后都会执行该 URL 定义的操作。当然,直接把存在 CSRF漏洞的 URL 发在论坛里或者发送给受害者点击，也是一种漏洞利用方式，只是需要受害者自己去点击，攻击效率会低一些

#### 1.3 CSRF的危害

以受害者名义发送邮件，发消息，盗取受害者的账号，甚至购买商品，虚拟货币转账，修改受害者的网络配置（比如修改路由器DNS、重置路由器密码）等。造成的问题包括：个人隐私泄露、机密数据泄露、用户甚至企业的财产安全等

**总结：**盗用受害者身份，受害者能做什么，攻击者就能以受害者的身份做什么

**日常场景的例子：**

> 就是某个人点了个奇怪的链接，自己什么也没输，但自己的qq号或其他的号就被盗了。即该攻击可以在受害者不知情的情况下以受害者名义伪造请求，执行恶意操作，具有很大的危害性。

#### 1.4 CSRF与XSS的区别

CSRF听起来很像跨站脚本攻击（XSS），但它与XSS有很大区别

**XSS 利用的是用户对指定网站的信任**

**CSRF 利用的是网站对用户网页浏览器的信任。**

![image-20240724145915005](https://gitee.com/zh0y0/picture/raw/master/zh0y0/image-20240724145915005.png)

**为什么在CSRF中，攻击者不去直接拿Cookie呢？**

XSS中，攻击者利用XSS植入JS代码，通过JS代码获取当前网站的Cookie，然后将Cookie发送到指定的服务器，在XSS中，之所有攻击者能拿到Cookie,是因为其行为不违背同源策略。

同源策略：

同协议、同域名、同ip、同端口 

```
http://www.5isec.cn
https://www.5isec.cn 
不同源

http://www.5isec.cn
http://stu.5isec.cn
不同源 

http://www.5isec.cn:80
http://www.5isec.cn
同源
浏览器默认情况下，不允许不同源的站点之间相互进行DOM的操作
```

**因为不满足同源策略的要求，所以不能直接获取目标站点下用户的Cookie**

### 二、CSRF漏洞探测

#### 2.1 检测Referer字段

检测CSRF漏洞是一项比较繁琐的工作，最简单的方法就是抓取一个正常请求的数据包，去掉Referer字段后再重新提交，如果该提交还有效，那么基本上可以确定存在CSRF漏洞。

Referer字段：根据HTTP协议，在HTTP头中有一个字段叫Referer，它记录了该HTTP请求的来源地址。

#### 2.2 CSRF漏洞利用条件

1、被害用户已经完成身份认证

2、新提交的请求不需要重新身份认证或确认机制

3、攻击者必须了解Web 请求的参数构造

4、诱使用户触发攻击的指令(社工)

#### 2.3 获取web请求参数构造的方法

1.注册同网站的账号

2.搭建同网站的本地测试环境

3.使用FUZZ模糊测试，爆破参数

#### 2.4 靶场演示

演示1： 

攻击类型为get

演示靶场为DVWA

测试方法：手动测试



演示2：

攻击类型为post

演示靶场为pikachu

测试方法：工具测试（burpsuite）

### 三、漏洞利用

利用1： 

利用靶场：MetInfo CMS

利用方法：添加管理员用户

工具：CSRFTester

利用2：

利用靶场：骑士 CMS

利用方法：添加管理员用户

工具：burpsuite

### 四、CSRF防御

CSRF漏洞防御主要可以从两个层面进行，即服务端的防御、用户端的防御

#### 4.1 服务端防御

##### 4.1.1 验证HTTP Referer字段

根据HTTP协议，在HTTP头中有一个字段叫Referer，它记录了该HTTP请求的来源地址。在通常情况下，访问一个安全受限页面的请求必须来自于同一个网站。比如某银行的转账是通过用户访问[http://](https://link.zhihu.com/?target=http%3A//bank.test/test%3Fpage%3D10%26userID%3D1%26money%3D10000)[bank.test/test?](https://link.zhihu.com/?target=http%3A//bank.test/test%3Fpage%3D10%26userID%3D1%26money%3D10000)[page=10&userID=1&money=10000](https://link.zhihu.com/?target=http%3A//bank.test/test%3Fpage%3D10%26userID%3D1%26money%3D10000)页面完成，用户必须先登录，然后通过点击页面上的按钮来触发转账事件。当用户提交请求时，该bank. test转账请求的Referer值就会是转账按钮所在页面的URL（本例中，通常是以bank. test域名开头的地址）。而如果攻击者要对银行网站实施CSRF攻击，他只能在自己的网站构造请求，当用户通过攻击者的网站发送请求到银行时，该请求的Referer是指向攻击者的网站。因此，要防御CSRF攻击，银行网站只需要对于每一个转账请求验证其Referer值，如果是以bank. test开头的域名，则说明该请求是来自银行网站自己的请求，是合法的。如果Referer是其他网站的话，就有可能是CSRF攻击，则拒绝该请求。

##### 4.1.2 在请求地址中添加token并验证

CSRF攻击之所以能够成功，是因为攻击者可以伪造用户的请求，该请求中所有的用户验证信息都存在于Cookie中，因此攻击者可以在不知道这些验证信息的情况下直接利用用户自己的Cookie来通过安全验证。由此可知，抵御CSRF攻击的关键在于：在请求中放入攻击者所不能伪造的信息，并且该信息不存在于Cookie之中。鉴于此，系统开发者可以在HTTP请求中以参数的形式加入一个随机产生的token，并在服务器端建立一个拦截器来验证这个token，如果请求中没有token或者token内容不正确，则认为可能是CSRF攻击而拒绝该请求。

##### 4.1.3 同源策略

同源策略，它是由Netscape提出的一个著名的安全策略。 当一个浏览器的两个tab页中分别打开来 百度和谷歌的页面 当浏览器的百度tab页执行一个脚本的时候会检查这个脚本是属于哪个页面的， 即检查是否同源，只有和百度同源的脚本才会被执行。 如果非同源，那么在请求数据时，浏览器会在控制台中报一个异常，提示拒绝访问。同源策略是浏览器的行为，是为了保护本地数据不被JavaScript代码获取回来的数据污染，因此拦截的是客户端发出的请求回来的数据接收，即请求发送了，服务器响应了，但是无法被浏览器接收。

##### 4.1.4 在HTTP头中自定义属性并验证

自定义属性的方法也是使用token并进行验证，和前一种方法不同的是，这里并不是把token以参数的形式置于HTTP请求之中，而是把它放到HTTP头中自定义的属性里。通过XMLHttpRequest这个类，可以一次性给所有该类请求加上csrftoken这个HTTP头属性，并把token值放入其中。这样解决了前一种方法在请求中加入token的不便，同时，通过这个类请求的地址不会被记录到浏览器的地址栏，也不用担心token会通过Referer泄露到其他网站。

##### 4.1.5 使用验证码或者密码确认方式进行

这种方法很有效，但是用户体验就差了些

#### 4.2 客户端防御

**养成良好的上网习惯**

1. 不要轻易点击网络论坛、聊天室、即时通讯工具或电子邮件中出现的链接或者图片；

2. 及时退出长时间不使用的已登录账户，尤其是系统管理员，应尽量在登出系统的情况下点击未知链接和图片

3. 在连接互联网的计算机上安装合适的安全防护软件，并及时更新软件厂商发布的特征库，以保持安全软件对最新攻击的实时跟踪。